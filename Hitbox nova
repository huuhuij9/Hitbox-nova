-- Configurações Globais
getgenv().HBE_Enabled = true
getgenv().WallCheck = true
getgenv().Skeleton_Enabled = true -- Ativa/Desativa o Esqueleto
getgenv().HitboxSize = 10
getgenv().SkeletonColor = Color3.fromRGB(255, 255, 255)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- Conexões de ossos para personagens R15
local BoneStructure = {
    {"Head", "UpperTorso"},
    {"UpperTorso", "LowerTorso"},
    {"UpperTorso", "LeftUpperArm"},
    {"LeftUpperArm", "LeftLowerArm"},
    {"LeftLowerArm", "LeftHand"},
    {"UpperTorso", "RightUpperArm"},
    {"RightUpperArm", "RightLowerArm"},
    {"RightLowerArm", "RightHand"},
    {"LowerTorso", "LeftUpperLeg"},
    {"LeftUpperLeg", "LeftLowerLeg"},
    {"LeftLowerLeg", "LeftFoot"},
    {"LowerTorso", "RightUpperLeg"},
    {"RightUpperLeg", "RightLowerLeg"},
    {"RightLowerLeg", "RightFoot"}
}

local function CreateLine()
    local line = Drawing.new("Line")
    line.Thickness = 1.5
    line.Color = getgenv().SkeletonColor
    line.Transparency = 1
    line.Visible = false
    return line
end

local PlayerSkeletons = {}

-- Função de Raycast para WallCheck
local function IsBehindWall(targetPart)
    if not getgenv().WallCheck then return false end
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return true end
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {char, targetPart.Parent}
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    
    local result = workspace:Raycast(char.HumanoidRootPart.Position, (targetPart.Position - char.HumanoidRootPart.Position), raycastParams)
    return result ~= nil 
end

-- Gerenciamento de limpeza quando jogador sai
Players.PlayerRemoving:Connect(function(player)
    if PlayerSkeletons[player] then
        for _, line in pairs(PlayerSkeletons[player]) do line:Remove() end
        PlayerSkeletons[player] = nil
    end
end)

RunService.RenderStepped:Connect(function()
    for _, player in pairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        
        local char = player.Character
        if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
            local hrp = char.HumanoidRootPart
            
            -- Lógica do HBE (Hitbox)
            if getgenv().HBE_Enabled and not IsBehindWall(hrp) then
                hrp.Size = Vector3.new(getgenv().HitboxSize, getgenv().HitboxSize, getgenv().HitboxSize)
                hrp.Transparency = 1 -- Melhor deixar visível para saber onde atirar
                hrp.CanCollide = false
            else
                hrp.Size = Vector3.new(2, 2, 1)
                hrp.Transparency = 1
            end

            -- Lógica do Skeleton ESP
            if getgenv().Skeleton_Enabled then
                if not PlayerSkeletons[player] then
                    PlayerSkeletons[player] = {}
                    for i = 1, #BoneStructure do table.insert(PlayerSkeletons[player], CreateLine()) end
                end

                for i, bone in pairs(BoneStructure) do
                    local partA = char:FindFirstChild(bone[1])
                    local partB = char:FindFirstChild(bone[2])
                    local line = PlayerSkeletons[player][i]

                    if partA and partB then
                        local posA, onScreenA = Camera:WorldToViewportPoint(partA.Position)
                        local posB, onScreenB = Camera:WorldToViewportPoint(partB.Position)

                        if onScreenA and onScreenB then
                            line.From = Vector2.new(posA.X, posA.Y)
                            line.To = Vector2.new(posB.X, posB.Y)
                            line.Visible = true
                        else
                            line.Visible = false
                        end
                    else
                        line.Visible = false
                    end
                end
            end
        else
            -- Esconde o esqueleto se o jogador morrer ou sumir
            if PlayerSkeletons[player] then
                for _, line in pairs(PlayerSkeletons[player]) do line.Visible = false end
            end
        end
    end
end)
